<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zelvora Handfree Tutor</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #0b1d3a, #020617);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: system-ui, -apple-system, sans-serif;
  color: #fff;
}

.card {
  width: 90%;
  max-width: 360px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(16px);
  border-radius: 22px;
  padding: 24px;
  text-align: center;
}

.mic {
  width: 72px;
  height: 72px;
  background: #2563eb;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
  margin: 14px auto;
}

.status {
  font-size: 13px;
  color: #94a3b8;
  margin-bottom: 10px;
}

.box {
  background: rgba(0,0,0,0.25);
  border-radius: 12px;
  padding: 10px;
  font-size: 13px;
  min-height: 42px;
  margin: 8px 0;
  text-align: left;
  white-space: pre-wrap;
}

.buttons {
  margin-top: 12px;
}

button {
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  font-weight: 600;
  margin: 4px;
  cursor: pointer;
}

.start { background: #2563eb; color: #fff; }
.stop  { background: #ef4444; color: #fff; }
</style>
</head>

<body>
<div class="card">
  <h3>ðŸŽ§ Zelvora Handfree Tutor</h3>
  <div class="status" id="status">Tap Start to speak</div>

  <div class="mic">ðŸŽ¤</div>

  <div class="box" id="transcript">Your speech will appear hereâ€¦</div>
  <div class="box" id="feedback">AI feedback will appear hereâ€¦</div>

  <div class="buttons">
    <button class="start" onclick="startListening()">Start Listening</button>
    <button class="stop" onclick="stopListening()">Stop</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://zelvora-ai.zelvora-global.workers.dev";

/* ================= STATE ================= */
let recognition;
let listening = false;
let autoLoop = true;

/* ================= SPEECH RECOGNITION ================= */
const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;

function startListening() {
  if (listening || !SpeechRec) return;

  recognition = new SpeechRec();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.continuous = false;

  recognition.onstart = () => {
    listening = true;
    status.textContent = "Listeningâ€¦ speak naturally";
  };

  recognition.onresult = e => {
    const text = e.results[0][0].transcript.trim();
    transcript.textContent = text;
    listening = false;
    sendToAI(text);
  };

  recognition.onerror = () => {
    listening = false;
    status.textContent = "Tap Start to try again";
  };

  recognition.start();
}

function stopListening() {
  autoLoop = false;
  if (recognition) recognition.stop();
  status.textContent = "Stopped";
}

/* ================= BACKEND CALL ================= */
async function sendToAI(text) {
  if (text.length < 4) {
    feedback.textContent =
      "Please say a full sentence, for example: I want to improve my English.";
    return;
  }

  status.textContent = "Thinkingâ€¦";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const data = await res.json();
    feedback.textContent = data.reply || "Try again.";
    speak(data.reply || "");
  } catch {
    feedback.textContent =
      "Letâ€™s try again. Say a full sentence slowly.";
    status.textContent = "Tap Start to continue";
  }
}

/* ================= TEXT TO SPEECH ================= */
function speak(text) {
  if (!text) return;

  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;

  u.onstart = () => {
    status.textContent = "AI speakingâ€¦";
  };

  u.onend = () => {
    status.textContent = "Tap Start to continue";

    // âœ… SAFE CONTINUOUS LOOP
    if (autoLoop && !text.includes("Letâ€™s try again")) {
      setTimeout(() => startListening(), 900);
    }
  };

  speechSynthesis.speak(u);
}
</script>
</body>
</html>
