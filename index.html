<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zelvora AI â€“ Spoken English</title>

<style>
:root{
  --blue:#38bdf8;
  --glass:rgba(255,255,255,.08);
}
*{box-sizing:border-box}
body{
  margin:0;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family:Inter,system-ui,-apple-system;
  background:
    radial-gradient(circle at 20% 10%, #1e3a8a, transparent 40%),
    radial-gradient(circle at 80% 80%, #0ea5e9, transparent 40%),
    linear-gradient(180deg,#020617,#020617);
  color:#fff;
  overflow:hidden;
}
.card{
  width:92%;
  max-width:360px;
  background:var(--glass);
  backdrop-filter:blur(18px);
  border-radius:24px;
  padding:22px;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 30px 80px rgba(0,0,0,.5);
  animation:float 6s ease-in-out infinite;
}
@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}
h3{
  margin:0 0 6px;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
}
.status{
  font-size:13px;
  color:#94a3b8;
}
.mic{
  width:88px;
  height:88px;
  margin:18px auto;
  border-radius:50%;
  background:linear-gradient(135deg,#38bdf8,#2563eb);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:34px;
  box-shadow:0 0 0 0 rgba(56,189,248,.6);
  animation:pulse 2s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(56,189,248,.6)}
  70%{box-shadow:0 0 0 22px rgba(56,189,248,0)}
  100%{box-shadow:0 0 0 0 rgba(56,189,248,0)}
}
.box{
  background:rgba(0,0,0,.25);
  border-radius:14px;
  padding:12px;
  font-size:13px;
  min-height:44px;
  margin-top:10px;
  white-space:pre-wrap;
}
.buttons{
  margin-top:14px;
  display:flex;
  gap:10px;
}
button{
  flex:1;
  border:none;
  border-radius:14px;
  padding:11px;
  font-weight:600;
  cursor:pointer;
}
.start{background:#38bdf8;color:#020617}
.stop{background:#ef4444;color:#fff}
</style>
</head>

<body>
<div class="card">
  <h3>ðŸŽ§ Zelvora AI</h3>
  <div class="status" id="status">Tap Start to speak</div>

  <div class="mic">ðŸŽ¤</div>

  <div class="box" id="output">Waiting for your voiceâ€¦</div>

  <div class="buttons">
    <button class="start" onclick="restart()">Start</button>
    <button class="stop" onclick="stopAll()">Stop</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://zelvora-ai.zelvora-global.workers.dev";

/* ================= STATE ================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SR();

rec.continuous = false;          // âœ… FINAL PATCH
rec.interimResults = false;
rec.lang = "en-US";

let speaking = false;
let blocked = false;

/* ================= UI ================= */
const statusEl = document.getElementById("status");
const outputEl = document.getElementById("output");

/* ================= SPEECH INPUT ================= */
rec.onstart = () => {
  statusEl.textContent = "Listeningâ€¦";
};

rec.onresult = e => {
  if (blocked) return;
  const text = e.results[0][0].transcript.trim();
  if (!text) return;
  outputEl.textContent = text;
  sendToAI(text);
};

rec.onerror = () => {
  statusEl.textContent = "Mic error. Tap Start.";
};

/* ================= AI CALL ================= */
async function sendToAI(text){
  statusEl.textContent = "Thinkingâ€¦";
  try{
    const res = await fetch(API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ text })
    });
    const data = await res.json();

    if (!res.ok || !data.reply) {
      throw new Error("AI error");
    }

    outputEl.textContent = data.reply;
    speak(data.reply);

  }catch{
    blocked = true;
    statusEl.textContent = "Connection issue. Tap Start to retry.";
  }
}

/* ================= SPEAK ================= */
function speak(text){
  speaking = true;
  speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;

  u.onend = () => {
    speaking = false;
    if (!blocked) {
      statusEl.textContent = "Listeningâ€¦";
      rec.start();              // âœ… FINAL PATCH
    }
  };

  speechSynthesis.speak(u);
}

/* ================= CONTROLS ================= */
function restart(){
  blocked = false;
  outputEl.textContent = "Listeningâ€¦";
  statusEl.textContent = "Listeningâ€¦";
  rec.start();
}

function stopAll(){
  blocked = true;
  speechSynthesis.cancel();
  rec.stop();
  statusEl.textContent = "Stopped";
}
</script>
</body>
</html>
