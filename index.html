<script>
(() => {
  const t = localStorage.getItem("career_token");
  if(!t) location.href = "spoken-english-gate.html";

  try{
    const d = JSON.parse(atob(t));
    if(Date.now() > d.exp || d.uses.spoken <= 0){
      location.href = "spoken-english-gate.html";
    }
  }catch{
    location.href = "spoken-english-gate.html";
  }
})();
</script>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zelvora Voice Tutor</title>

<style>
body{
  margin:0;
  background:linear-gradient(135deg,#0f172a,#020617);
  color:#e5e7eb;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.app{
  width:100%;
  max-width:420px;
  background:rgba(255,255,255,.08);
  backdrop-filter:blur(20px);
  border-radius:22px;
  padding:22px;
}
h1{text-align:center;font-size:20px}
#status{text-align:center;font-size:13px;color:#94a3b8;margin:6px 0}
.chat{
  background:rgba(0,0,0,.3);
  border-radius:14px;
  padding:12px;
  height:280px;
  overflow:auto;
  font-size:14px;
}
.msg{margin-bottom:12px}
.user{color:#93c5fd}
.ai{color:#c4b5fd}
.mic{
  width:80px;height:80px;
  border-radius:50%;
  background:#2563eb;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:34px;
  margin:18px auto;
}
.mic.active{background:#dc2626}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
}
</style>
</head>

<body>
<div class="app">
  <h1>ðŸŽ§ Zelvora Voice Tutor</h1>
  <div id="status">Tap Start & speak freely</div>

  <div class="chat" id="chat">
    <div class="msg ai">Hi! Start speaking â€” Iâ€™ll listen and respond.</div>
  </div>

  <div class="mic" id="mic">ðŸŽ¤</div>
  <button onclick="start()">Start</button>
</div>

<script>
const API = "https://late-mouse-4aa2.zelvora-global.workers.dev";
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition;
let listening = false;
let auto = false;
let memory = [];

function start(){
  auto = true;
  listen();
}

function listen(){
  if(listening || !auto) return;

  recognition = new SR();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = ()=>{
    listening=true;
    mic.classList.add("active");
    status("ðŸŽ¤ Listeningâ€¦");
  };

  recognition.onresult = e=>{
    const text = e.results[0][0].transcript;
    add("user",text);
    recognition.stop();
    send(text);
  };

  recognition.onend = ()=>{
    listening=false;
    mic.classList.remove("active");
  };

  recognition.onerror = ()=>{
    listening=false;
    mic.classList.remove("active");
    setTimeout(listen,1000);
  };

  recognition.start();
}

async function send(text){
  status("ðŸ¤– Thinkingâ€¦");

  memory.push({ role:"user", content:text });
  memory = memory.slice(-10);

  try{
    const r = await fetch(API,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ text, history: memory })
    });
    const d = await r.json();

    add("ai",d.reply);
    memory.push({ role:"assistant", content:d.reply });
    speak(d.reply);
  }catch{
    add("ai","Connection issue. Please continue.");
    setTimeout(listen,800);
  }
}

function speak(text){
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate=0.9;

  u.onstart=()=>status("ðŸ”Š AI speakingâ€¦");
  u.onend=()=>{ status("ðŸŽ¤ Listeningâ€¦"); if(auto) setTimeout(listen,600); };

  speechSynthesis.speak(u);
}

function add(who,text){
  const div=document.createElement("div");
  div.className="msg "+who;
  div.textContent=(who==="user"?"You: ":"Tutor: ")+text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

function status(t){ document.getElementById("status").textContent=t; }
</script>
</body>
</html>
