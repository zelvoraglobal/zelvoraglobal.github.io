export default {
  async fetch(req) {

    /* CORS */
    if (req.method === "OPTIONS") {
      return new Response(null, {
        headers: {
          "Access-Control-Allow-Origin": "*",
          "Access-Control-Allow-Methods": "POST, OPTIONS",
          "Access-Control-Allow-Headers": "Content-Type",
        }
      });
    }

    if (req.method !== "POST") {
      return json({
        status: "ok",
        message: "Zelvora Spoken English (No AI API)",
        timestamp: new Date().toISOString()
      });
    }

    try {
      const { text } = await req.json();

      if (!text || text.trim().length < 3) {
        return reply("Please speak a complete sentence.");
      }

      const cleaned = cleanGrammar(text);
      const improved = improveFluency(cleaned);
      const tip = randomTip();

      return reply(
`Correction:
${cleaned}

Improved Sentence:
${improved}

Tip:
${tip}`
      );

    } catch (e) {
      return reply("Please repeat your sentence clearly.");
    }
  }
};

/* ---------- Helpers ---------- */

function reply(message) {
  return json({ reply: message });
}

function json(data) {
  return new Response(JSON.stringify(data), {
    headers: {
      "Content-Type": "application/json",
      "Access-Control-Allow-Origin": "*",
    }
  });
}

function cleanGrammar(text) {
  return text
    .replace(/\bi am not confident\b/i, "I am not confident")
    .replace(/\bi cant\b/i, "I can't")
    .replace(/\bhow can i help you\b/i, "How can I help you?")
    .replace(/\bi need job\b/i, "I need a job")
    .replace(/\s+/g, " ")
    .trim()
    .replace(/^[a-z]/, c => c.toUpperCase());
}

function improveFluency(text) {
  if (text.toLowerCase().includes("not confident")) {
    return "I am not confident speaking English yet, but I am learning.";
  }
  if (text.toLowerCase().includes("need a job")) {
    return "I am currently looking for a suitable job opportunity.";
  }
  return text;
}

function randomTip() {
  const tips = [
    "Speak slowly and clearly.",
    "Do not worry about mistakes.",
    "Practice speaking every day.",
    "Listen to English conversations.",
    "Focus on complete sentences."
  ];
  return tips[Math.floor(Math.random() * tips.length)];
}
